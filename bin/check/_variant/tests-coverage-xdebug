#!/usr/bin/env sh

# Do not modify this file - this file is created by bin/wrapper/dist-sync and will be overriden every time dist-sync is invoked.
# see https://gitlab.brainbits.net/docker/dist/-/blob/master/README.md

. "$(dirname $0)/../../config"

cmd=$*
if [ $# -eq 0 ]; then
    cmd="--coverage-text"

    if [ -n "${TESTS_REPORT_FILE}" ]; then
        printf "${warning}Setting log-junit via ${warning_name}TESTS_REPORT_FILE${warning} is now deprecated. Use ${warning_name}TESTS_JUNIT_FILE${warning} instead.${reset}\n"
        mkdir -p "$(dirname ${TESTS_REPORT_FILE})"
        cmd="${cmd} --log-junit=${TESTS_REPORT_FILE}"
    fi

    if [ -n "${TESTS_JUNIT_FILE}" ]; then
        mkdir -p "$(dirname ${TESTS_JUNIT_FILE})"
        cmd="${cmd} --log-junit=${TESTS_JUNIT_FILE}"
    fi

    if [ -n "${TESTS_CLOVER_FILE}" ]; then
        mkdir -p "$(dirname ${TESTS_CLOVER_FILE})"
        cmd="${cmd} --coverage-clover=${TESTS_CLOVER_FILE}"
    fi

    if [ -n "${TESTS_COBERTURA_FILE}" ]; then
        mkdir -p "$(dirname ${TESTS_COBERTURA_FILE})"
        cmd="${cmd} --coverage-cobertura=${TESTS_COBERTURA_FILE}"
    fi

    if [ -n "${TESTS_COVERAGE_DIR}" ]; then
        mkdir -p "${TESTS_COVERAGE_DIR}"
        cmd="${cmd} --coverage-html=${TESTS_COVERAGE_DIR}"
    fi

    if [ -n "${CI}" ]; then
        cmd="${cmd} --colors=never"
    fi
fi

if [ "$PHPUNIT_CMD" = "phpunit6" ]; then
    # phpunit 6.x does not support xdebug filter options
    "${BIN_DIR}/wrapper/devtools-phpunit-coverage-xdebug" ${cmd}
else
    "${BIN_DIR}/wrapper/devtools-phpunit" --dump-xdebug-filter .xdebug-filter.php
    "${BIN_DIR}/wrapper/devtools-phpunit-coverage-xdebug" --prepend .xdebug-filter.php ${cmd}
fi
