#!/usr/bin/env sh

# Do not modify this file - this file is created by bin/wrapper/dist-sync and will be overriden every time dist-sync is invoked.
# see https://gitlab.brainbits.net/docker/dist/-/blob/master/README.md

. "$(dirname $0)/../config"

blackfireSocket="${BLACKFIRE_SOCKET:=tcp://host.docker.internal:8307}"

if [ -z "$BLACKFIRE_CLIENT_ID" ] || [ -z "$BLACKFIRE_CLIENT_TOKEN" ]; then
    echo "Set BLACKFIRE_CLIENT_ID and BLACKFIRE_CLIENT_TOKEN environment variables and run blackfire agent on port 8307."
    echo "See https://gitlab.brainbits.net/docker/php/blob/master/README.blackfire.md for detailed information."
    exit 1
fi

blackfireCmd="${BLACKFIRE_CMD:=blackfire}"
phpunitCmd="${PHPUNIT_CMD:=phpunit}"

fullPhpunitCmd=$(docker run --rm --init "${DEVTOOLS_IMAGE}" which "${phpunitCmd}")

cmd="${blackfireCmd} run ${fullPhpunitCmd} ${ARGS}"
showCmd "${cmd}"

docker run $(interactiveTty) --rm --init \
    ${DOCKER_USER} \
    --volume "${DIR}:/app${DOCKER_MOUNT_MODE}" \
    --env PHP_ACTIVATE_BLACKFIRE=1 \
    --env "PHP_BLACKFIRE_SOCKET=${blackfireSocket}" \
    --env BLACKFIRE_CLIENT_ID \
    --env BLACKFIRE_CLIENT_TOKEN \
    ${WRAPPER_DOCKER_EXTRAS} \
    ${DEVTOOLS_DOCKER_EXTRAS} \
    "${DEVTOOLS_IMAGE}" \
    ${cmd}
